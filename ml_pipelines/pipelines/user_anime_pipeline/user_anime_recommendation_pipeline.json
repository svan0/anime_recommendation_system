{
  "pipelineSpec": {
    "components": {
      "comp-component": {
        "executorLabel": "exec-component",
        "inputDefinitions": {
          "artifacts": {
            "all_anime_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "all_user_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "test_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "train_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "val_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          },
          "parameters": {
            "early_stop_num_epochs": {
              "type": "INT"
            },
            "learning_rate": {
              "type": "DOUBLE"
            },
            "max_num_epochs": {
              "type": "INT"
            },
            "optimizer": {
              "type": "STRING"
            },
            "user_anime_embedding_size": {
              "type": "INT"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_metric_path": {
              "artifactType": {
                "schemaTitle": "system.Metrics",
                "schemaVersion": "0.0.1"
              }
            },
            "output_model_path": {
              "artifactType": {
                "schemaTitle": "system.Model",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-component-2": {
        "executorLabel": "exec-component-2",
        "inputDefinitions": {
          "artifacts": {
            "input_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "model_path": {
              "artifactType": {
                "schemaTitle": "system.Model",
                "schemaVersion": "0.0.1"
              }
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-component-3": {
        "executorLabel": "exec-component-3",
        "inputDefinitions": {
          "artifacts": {
            "all_anime_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "all_user_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "test_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "train_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "val_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          },
          "parameters": {
            "anime_embedding_size": {
              "type": "INT"
            },
            "early_stop_num_epochs": {
              "type": "INT"
            },
            "learning_rate": {
              "type": "DOUBLE"
            },
            "max_num_epochs": {
              "type": "INT"
            },
            "optimizer": {
              "type": "STRING"
            },
            "scoring_layer_size": {
              "type": "INT"
            },
            "user_embedding_size": {
              "type": "INT"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_metric_path": {
              "artifactType": {
                "schemaTitle": "system.Metrics",
                "schemaVersion": "0.0.1"
              }
            },
            "output_model_path": {
              "artifactType": {
                "schemaTitle": "system.Model",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-component-4": {
        "executorLabel": "exec-component-4",
        "inputDefinitions": {
          "artifacts": {
            "input_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            },
            "model_path": {
              "artifactType": {
                "schemaTitle": "system.Model",
                "schemaVersion": "0.0.1"
              }
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_data_path": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data": {
        "executorLabel": "exec-load-big-query-data",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-2": {
        "executorLabel": "exec-load-big-query-data-2",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-3": {
        "executorLabel": "exec-load-big-query-data-3",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-4": {
        "executorLabel": "exec-load-big-query-data-4",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-5": {
        "executorLabel": "exec-load-big-query-data-5",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-6": {
        "executorLabel": "exec-load-big-query-data-6",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-7": {
        "executorLabel": "exec-load-big-query-data-7",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-data-8": {
        "executorLabel": "exec-load-big-query-data-8",
        "inputDefinitions": {
          "parameters": {
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      },
      "comp-load-big-query-external-data": {
        "executorLabel": "exec-load-big-query-external-data",
        "inputDefinitions": {
          "artifacts": {
            "external_table_uri": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          },
          "parameters": {
            "external_table_id": {
              "type": "STRING"
            },
            "external_table_schema": {
              "type": "STRING"
            },
            "query": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "output_csv": {
              "artifactType": {
                "schemaTitle": "system.Dataset",
                "schemaVersion": "0.0.1"
              }
            }
          }
        }
      }
    },
    "deploymentSpec": {
      "executors": {
        "exec-component": {
          "container": {
            "command": [
              "python3",
              "ml_pipelines/components/user_anime/train_retrieval/src/task.py",
              "--train-data-path",
              "{{$.inputs.artifacts['train_data_path'].path}}",
              "--val-data-path",
              "{{$.inputs.artifacts['val_data_path'].path}}",
              "--test-data-path",
              "{{$.inputs.artifacts['test_data_path'].path}}",
              "--all-anime-data-path",
              "{{$.inputs.artifacts['all_anime_data_path'].path}}",
              "--all-user-data-path",
              "{{$.inputs.artifacts['all_user_data_path'].path}}",
              "--output-model-path",
              "{{$.outputs.artifacts['output_model_path'].path}}",
              "--output-metrics-path",
              "{{$.outputs.artifacts['output_metric_path'].path}}",
              "--user-anime-embedding-size",
              "{{$.inputs.parameters['user_anime_embedding_size']}}",
              "--learning-rate",
              "{{$.inputs.parameters['learning_rate']}}",
              "--optimizer",
              "{{$.inputs.parameters['optimizer']}}",
              "--max-num-epochs",
              "{{$.inputs.parameters['max_num_epochs']}}",
              "--early-stop-num-epochs",
              "{{$.inputs.parameters['early_stop_num_epochs']}}"
            ],
            "image": "gcr.io/anime-rec-dev/ml_image@sha256:4c5a77c06c20c94ca8f50fd1a60dc6c4d4b4918d1aff40333a3373bbd4e4cc9c"
          }
        },
        "exec-component-2": {
          "container": {
            "command": [
              "python3",
              "ml_pipelines/components/user_anime/infer_retrieval/src/task.py",
              "--model-path",
              "{{$.inputs.artifacts['model_path'].path}}",
              "--input-data-path",
              "{{$.inputs.artifacts['input_data_path'].path}}",
              "--output-data-path",
              "{{$.outputs.artifacts['output_data_path'].path}}"
            ],
            "image": "gcr.io/anime-rec-dev/ml_image@sha256:4c5a77c06c20c94ca8f50fd1a60dc6c4d4b4918d1aff40333a3373bbd4e4cc9c"
          }
        },
        "exec-component-3": {
          "container": {
            "command": [
              "python3",
              "ml_pipelines/components/user_anime/train_ranking/src/task.py",
              "--train-data-path",
              "{{$.inputs.artifacts['train_data_path'].path}}",
              "--val-data-path",
              "{{$.inputs.artifacts['val_data_path'].path}}",
              "--test-data-path",
              "{{$.inputs.artifacts['test_data_path'].path}}",
              "--all-anime-data-path",
              "{{$.inputs.artifacts['all_anime_data_path'].path}}",
              "--all-user-data-path",
              "{{$.inputs.artifacts['all_user_data_path'].path}}",
              "--output-model-path",
              "{{$.outputs.artifacts['output_model_path'].path}}",
              "--output-metrics-path",
              "{{$.outputs.artifacts['output_metric_path'].path}}",
              "--anime-embedding-size",
              "{{$.inputs.parameters['anime_embedding_size']}}",
              "--user-embedding-size",
              "{{$.inputs.parameters['user_embedding_size']}}",
              "--scoring-layer-size",
              "{{$.inputs.parameters['scoring_layer_size']}}",
              "--learning-rate",
              "{{$.inputs.parameters['learning_rate']}}",
              "--optimizer",
              "{{$.inputs.parameters['optimizer']}}",
              "--max-num-epochs",
              "{{$.inputs.parameters['max_num_epochs']}}",
              "--early-stop-num-epochs",
              "{{$.inputs.parameters['early_stop_num_epochs']}}"
            ],
            "image": "gcr.io/anime-rec-dev/ml_image@sha256:4c5a77c06c20c94ca8f50fd1a60dc6c4d4b4918d1aff40333a3373bbd4e4cc9c"
          }
        },
        "exec-component-4": {
          "container": {
            "command": [
              "python3",
              "ml_pipelines/components/user_anime/infer_ranking/src/task.py",
              "--model-path",
              "{{$.inputs.artifacts['model_path'].path}}",
              "--input-data-path",
              "{{$.inputs.artifacts['input_data_path'].path}}",
              "--output-data-path",
              "{{$.outputs.artifacts['output_data_path'].path}}"
            ],
            "image": "gcr.io/anime-rec-dev/ml_image@sha256:4c5a77c06c20c94ca8f50fd1a60dc6c4d4b4918d1aff40333a3373bbd4e4cc9c"
          }
        },
        "exec-load-big-query-data": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-2": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-3": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-4": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-5": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-6": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-7": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-data-8": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_data(query:str, output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n    dataset_ref = client.dataset(\"prod_area_us\")\n    job_config = bigquery.QueryJobConfig()\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        },
        "exec-load-big-query-external-data": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "load_big_query_external_data"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'google-cloud-bigquery==2.31.0' 'pyarrow==6.0.1' 'pandas==1.3.4' 'kfp==1.8.10' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef load_big_query_external_data(external_table_uri:Input[Dataset],\n                                 external_table_schema:list,\n                                 external_table_id:str,\n                                 query:str, \n                                 output_csv:Output[Dataset]):\n    from google.cloud import bigquery\n    client = bigquery.Client(project=\"anime-rec-dev\")\n\n    external_config = bigquery.ExternalConfig(\"CSV\")\n    external_config.source_uris = [\n        external_table_uri.path.replace('/gcs/', 'gs://')\n    ]\n    external_config.schema = [bigquery.SchemaField(x[0], x[1]) for x in external_table_schema]\n    external_config.options.skip_leading_rows = 1\n\n    job_config = bigquery.QueryJobConfig(table_definitions={external_table_id: external_config})\n    query_job = client.query(query, job_config=job_config)\n    data = query_job.to_dataframe()\n    data.to_csv(output_csv.path, index = False)\n\n"
            ],
            "image": "python:3.7"
          }
        }
      }
    },
    "pipelineInfo": {
      "name": "user-anime-recommendation-pipeline"
    },
    "root": {
      "dag": {
        "outputs": {
          "artifacts": {
            "component-3-output_metric_path": {
              "artifactSelectors": [
                {
                  "outputArtifactKey": "output_metric_path",
                  "producerSubtask": "component-3"
                }
              ]
            },
            "component-output_metric_path": {
              "artifactSelectors": [
                {
                  "outputArtifactKey": "output_metric_path",
                  "producerSubtask": "component"
                }
              ]
            }
          }
        },
        "tasks": {
          "component": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-component"
            },
            "dependentTasks": [
              "load-big-query-data",
              "load-big-query-data-2",
              "load-big-query-data-3",
              "load-big-query-data-7",
              "load-big-query-data-8"
            ],
            "inputs": {
              "artifacts": {
                "all_anime_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-7"
                  }
                },
                "all_user_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-8"
                  }
                },
                "test_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-3"
                  }
                },
                "train_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data"
                  }
                },
                "val_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-2"
                  }
                }
              },
              "parameters": {
                "early_stop_num_epochs": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "5"
                    }
                  }
                },
                "learning_rate": {
                  "runtimeValue": {
                    "constantValue": {
                      "doubleValue": 0.005
                    }
                  }
                },
                "max_num_epochs": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "30"
                    }
                  }
                },
                "optimizer": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "adam"
                    }
                  }
                },
                "user_anime_embedding_size": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "128"
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "train retrieval model"
            }
          },
          "component-2": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-component-2"
            },
            "dependentTasks": [
              "component",
              "load-big-query-data-8"
            ],
            "inputs": {
              "artifacts": {
                "input_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-8"
                  }
                },
                "model_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_model_path",
                    "producerTask": "component"
                  }
                }
              }
            },
            "taskInfo": {
              "name": "infer retrieval model"
            }
          },
          "component-3": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-component-3"
            },
            "dependentTasks": [
              "load-big-query-data-4",
              "load-big-query-data-5",
              "load-big-query-data-6",
              "load-big-query-data-7",
              "load-big-query-data-8"
            ],
            "inputs": {
              "artifacts": {
                "all_anime_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-7"
                  }
                },
                "all_user_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-8"
                  }
                },
                "test_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-6"
                  }
                },
                "train_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-4"
                  }
                },
                "val_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-data-5"
                  }
                }
              },
              "parameters": {
                "anime_embedding_size": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "128"
                    }
                  }
                },
                "early_stop_num_epochs": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "5"
                    }
                  }
                },
                "learning_rate": {
                  "runtimeValue": {
                    "constantValue": {
                      "doubleValue": 0.005
                    }
                  }
                },
                "max_num_epochs": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "30"
                    }
                  }
                },
                "optimizer": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "adam"
                    }
                  }
                },
                "scoring_layer_size": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "128"
                    }
                  }
                },
                "user_embedding_size": {
                  "runtimeValue": {
                    "constantValue": {
                      "intValue": "256"
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "train ranking model"
            }
          },
          "component-4": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-component-4"
            },
            "dependentTasks": [
              "component-3",
              "load-big-query-external-data"
            ],
            "inputs": {
              "artifacts": {
                "input_data_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_csv",
                    "producerTask": "load-big-query-external-data"
                  }
                },
                "model_path": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_model_path",
                    "producerTask": "component-3"
                  }
                }
              }
            },
            "taskInfo": {
              "name": "infer ranking model"
            }
          },
          "load-big-query-data": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed'\n    ),\n    user_anime_data_with_completed_order AS (\n        SELECT user_id, anime_id, status, overall_score, last_interaction_date, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY last_interaction_date IS NULL ASC, last_interaction_date DESC) AS completed_order\n        FROM user_anime_data\n    )\n    \n        SELECT user_id, anime_id \n        FROM user_anime_data_with_completed_order \n        WHERE completed_order >= 21\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "train data : user anime retrieval"
            }
          },
          "load-big-query-data-2": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-2"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed'\n    ),\n    user_anime_data_with_completed_order AS (\n        SELECT user_id, anime_id, status, overall_score, last_interaction_date, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY last_interaction_date IS NULL ASC, last_interaction_date DESC) AS completed_order\n        FROM user_anime_data\n    )\n    \n        SELECT user_id, anime_id \n        FROM user_anime_data_with_completed_order \n        WHERE completed_order BETWEEN 11 AND 20\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "val data : user anime retrieval"
            }
          },
          "load-big-query-data-3": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-3"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed'\n    ),\n    user_anime_data_with_completed_order AS (\n        SELECT user_id, anime_id, status, overall_score, last_interaction_date, ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY last_interaction_date IS NULL ASC, last_interaction_date DESC) AS completed_order\n        FROM user_anime_data\n    )\n    \n        SELECT user_id, anime_id \n        FROM user_anime_data_with_completed_order \n        WHERE completed_order BETWEEN 1 AND 10\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "test data : user anime retrieval"
            }
          },
          "load-big-query-data-4": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-4"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date, ROW_NUMBER() OVER (PARTITION BY A.user_id ORDER BY A.last_interaction_date IS NULL ASC, A.last_interaction_date DESC) AS completed_order\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed' AND A.overall_score IS NOT NULL AND A.overall_score > 0\n    ),\n    train_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order >= 21\n    ),\n    train_data_random_order AS (\n        SELECT user_id, \n               anime_id, \n               overall_score, \n               ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY RAND()) - 1 AS random_order_anime_per_user\n        FROM train_data\n    ),\n    train_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM train_data_random_order\n        GROUP BY user_id, DIV(random_order_anime_per_user, 10)\n        HAVING ARRAY_LENGTH(anime_id) = 10\n    ),\n    val_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 11 AND 20\n    ),\n    val_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM val_data \n        GROUP BY user_id\n    ),\n    test_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 1 AND 10\n    ),\n    test_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM test_data \n        GROUP BY user_id\n    )\n    \n        SELECT *\n        FROM train_data_list\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "train data : user anime list ranking"
            }
          },
          "load-big-query-data-5": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-5"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date, ROW_NUMBER() OVER (PARTITION BY A.user_id ORDER BY A.last_interaction_date IS NULL ASC, A.last_interaction_date DESC) AS completed_order\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed' AND A.overall_score IS NOT NULL AND A.overall_score > 0\n    ),\n    train_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order >= 21\n    ),\n    train_data_random_order AS (\n        SELECT user_id, \n               anime_id, \n               overall_score, \n               ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY RAND()) - 1 AS random_order_anime_per_user\n        FROM train_data\n    ),\n    train_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM train_data_random_order\n        GROUP BY user_id, DIV(random_order_anime_per_user, 10)\n        HAVING ARRAY_LENGTH(anime_id) = 10\n    ),\n    val_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 11 AND 20\n    ),\n    val_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM val_data \n        GROUP BY user_id\n    ),\n    test_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 1 AND 10\n    ),\n    test_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM test_data \n        GROUP BY user_id\n    )\n    \n        SELECT *\n        FROM val_data_list\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "validation data : user anime list ranking"
            }
          },
          "load-big-query-data-6": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-6"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH \n    list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    ),\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    ),\n    user_anime_data AS (\n        SELECT A.user_id, A.anime_id, A.status, A.overall_score, A.last_interaction_date, ROW_NUMBER() OVER (PARTITION BY A.user_id ORDER BY A.last_interaction_date IS NULL ASC, A.last_interaction_date DESC) AS completed_order\n        FROM `anime-rec-dev.prod_area_us.user_anime` A\n        INNER JOIN list_users B\n        ON A.user_id = B.user_id\n        INNER JOIN list_anime C\n        ON A.anime_id = C.anime_id\n        WHERE A.status = 'completed' AND A.overall_score IS NOT NULL AND A.overall_score > 0\n    ),\n    train_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order >= 21\n    ),\n    train_data_random_order AS (\n        SELECT user_id, \n               anime_id, \n               overall_score, \n               ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY RAND()) - 1 AS random_order_anime_per_user\n        FROM train_data\n    ),\n    train_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM train_data_random_order\n        GROUP BY user_id, DIV(random_order_anime_per_user, 10)\n        HAVING ARRAY_LENGTH(anime_id) = 10\n    ),\n    val_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 11 AND 20\n    ),\n    val_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM val_data \n        GROUP BY user_id\n    ),\n    test_data AS (\n        SELECT user_id, anime_id, overall_score\n        FROM user_anime_data\n        WHERE completed_order BETWEEN 1 AND 10\n    ),\n    test_data_list AS (\n        SELECT user_id, ARRAY_AGG(anime_id) AS anime_id, ARRAY_AGG(overall_score) AS overall_score \n        FROM test_data \n        GROUP BY user_id\n    )\n    \n        SELECT *\n        FROM test_data_list\n        "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "test data : user anime list ranking"
            }
          },
          "load-big-query-data-7": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-7"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH\n    list_anime AS (\n        SELECT anime_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed'\n        GROUP BY anime_id\n        ORDER BY cnt DESC, anime_id\n        LIMIT 100\n    )\n    SELECT anime_id FROM list_anime\n    "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "all anime data"
            }
          },
          "load-big-query-data-8": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-data-8"
            },
            "inputs": {
              "parameters": {
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n    WITH list_users AS (\n        SELECT user_id, COUNT(*) AS cnt\n        FROM `anime-rec-dev.prod_area_us.user_anime`\n        WHERE status = 'completed' \n              AND overall_score IS NOT NULL \n              AND overall_score > 0 \n              AND last_interaction_date IS NOT NULL\n        GROUP BY user_id\n        ORDER BY cnt DESC, user_id\n        LIMIT 100\n    )\n    SELECT user_id FROM list_users\n    "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "all user data"
            }
          },
          "load-big-query-external-data": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-load-big-query-external-data"
            },
            "dependentTasks": [
              "component-2"
            ],
            "inputs": {
              "artifacts": {
                "external_table_uri": {
                  "taskOutputArtifact": {
                    "outputArtifactKey": "output_data_path",
                    "producerTask": "component-2"
                  }
                }
              },
              "parameters": {
                "external_table_id": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "unknown_retrieved"
                    }
                  }
                },
                "external_table_schema": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "[[\"user_id\", \"STRING\"], [\"retrieved_anime_id\", \"STRING\"]]"
                    }
                  }
                },
                "query": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "\n        SELECT A.user_id, A.retrieved_anime_id\n        FROM unknown_retrieved A\n        LEFT JOIN `anime-rec-dev.prod_area_us.user_anime` B\n        ON A.user_id = B.user_id AND A.retrieved_anime_id = B.anime_id\n        WHERE B.status IS NULL\n    "
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "remove known retrieved animes"
            }
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "component-3-output_metric_path": {
            "artifactType": {
              "schemaTitle": "system.Metrics",
              "schemaVersion": "0.0.1"
            }
          },
          "component-output_metric_path": {
            "artifactType": {
              "schemaTitle": "system.Metrics",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "schemaVersion": "2.0.0",
    "sdkVersion": "kfp-1.8.10"
  },
  "runtimeConfig": {}
}